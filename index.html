<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open CDB</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap');
</style>
    <style>
        body { font-family: "Noto Sans", serif; text-align: center; margin: 20px; }
        #chatbox { width: 90%; max-width: 400px; height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 20px auto; border-radius: 8px;}
        #userInput { width: 90%; padding: 10px; }
        button, input[type="file"] {font-family: "Noto Sans", serif; padding: 10px; margin: 10px; border-radius: 8px; border: 1px solid #ddd; display: none;}
.btn{
border: 1px solid #666;
background: #ddd;
padding: 5px; border-radius: 8px;
margin-left: 5px;
margin-right: 5px;
transition: 0.5s;
}
.btn:hover{
background: #007bff;
color: #fff;
}
input[type="text"]{
font-family: "Noto Sans", serif;
margin-bottom: 20px;
border: 1px solid #ddd;
outline: none;
padding: 5px;
border-radius: 8px;
}
        img { max-width: 100px; margin: 5px; border-radius: 8px; float: right;}
        .msg { padding: 5px; border-radius: 8px; word-wrap: break-word; margin: 5px;}
        .user { background: #007bff; color: white; text-align: right; float: right; width: 75%; border: 1px solid #003478;}
        .bot, .assistant { background: #ddd; text-align: left; float: left; width: 75%; border: 1px solid #666;}
::-moz-selection { /* Code for Firefox */
  color: #fff;
background: #000;
}

::selection {
  color: #fff;
background: #000;
}
    </style>
</head>
<body>

    <div style="line-height: 0.5;"><h2>Open Cognitive Data Bot</h2>
<p>ChatGPT 4o</p></div>
    <div id="chatbox"></div>

    <input type="text" id="userInput" placeholder="Ask something..." />
    <span class="btn" onclick="sendToJsonBin()">Send</span>
    <label for="imageInput"><span class="btn">Image</span></label>
<!---<span class="btn">Download</span>--->
    <input type="file" id="imageInput" accept="image/*" style="display:none;">

    <script>
        const JSONBIN_API_KEY = "$2a$10$lDRVfp9GcJ.iW4nCD7fHoeiqDRjfQJ.NxmpbnX5KYmUv9oDB/ZmsG";
        const CLOUDMERSIVE_API_KEY = "a034550d-534d-47ff-82b7-420d89915153";
        const ELEVENLABS_API_KEY = "sk_5a15bb30273e5a377d3f75c380af82bb4894ad128bf2d855";
        const VOICE_ID = "iP95p4xoKVk53GoZ742B"; 
        const BIN_ID = "67b377e3e41b4d34e491a231"; 

        document.addEventListener("DOMContentLoaded", loadPreviousMessages);

        function addMessage(text, sender) {
            const div = document.createElement("div");
            div.textContent = text;
            div.classList.add("msg", sender);
            document.getElementById("chatbox").appendChild(div);
            document.getElementById("chatbox").scrollTop = document.getElementById("chatbox").scrollHeight;
        }

        async function sendToJsonBin() {
            let userText = document.getElementById("userInput").value.trim();
            if (!userText) return;
            addMessage(userText, "user");
            document.getElementById("userInput").value = "";

            let response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                method: "GET",
                headers: { "X-Master-Key": JSONBIN_API_KEY }
            });

            let data = await response.json();
            let chatHistory = data.record.messages || [];
            chatHistory.push({ role: "user", content: userText });

            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": JSONBIN_API_KEY
                },
                body: JSON.stringify({ messages: chatHistory })
            });

            checkResponse();
        }

        async function checkResponse() {
            let interval = setInterval(async () => {
                let response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    method: "GET",
                    headers: { "X-Master-Key": JSONBIN_API_KEY }
                });

                let data = await response.json();
                let messages = data.record.messages || [];

                let lastMessage = messages[messages.length - 1];
                if (lastMessage.role === "assistant") {
                    addMessage(lastMessage.content, "bot");
                    textToSpeech(lastMessage.content);
                    clearInterval(interval);
                }
            }, 5000);
        }

        async function loadPreviousMessages() {
            let response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                method: "GET",
                headers: { "X-Master-Key": JSONBIN_API_KEY }
            });

            let data = await response.json();
            let messages = data.record.messages || [];

            messages.forEach(msg =>
addMessage(msg.content, `${msg.role}`));
        }

        document.getElementById("imageInput").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                addImageToChat(e.target.result, "user"); 
                detectObjects(file);
            };
            reader.readAsDataURL(file);
        });

        function addImageToChat(imageSrc, sender) {
            const div = document.createElement("div");
            div.classList.add("msg", sender);

            const img = document.createElement("img");
            img.src = imageSrc;
            div.appendChild(img);

            document.getElementById("chatbox").appendChild(div);
        }

        async function detectObjects(file) {
            const url = "https://api.cloudmersive.com/image/recognize/describe";
            const formData = new FormData();
            formData.append("imageFile", file);

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Apikey": CLOUDMERSIVE_API_KEY },
                    body: formData
                });

                const data = await response.json();
                const detectedObjects = data.BestOutcome?.Description || "No objects detected.";
                addMessage(`Detected: ${detectedObjects}`, "bot");
                textToSpeech(`Detected objects: ${detectedObjects}`);
            } catch (error) {
                addMessage("Error detecting objects.", "bot");
            }
        }

        async function textToSpeech(text) {
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "xi-api-key": ELEVENLABS_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.75, similarity_boost: 0.75 }
                    })
                });

                const arrayBuffer = await response.arrayBuffer();
                const audioBlob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
            } catch (error) {
                console.log("TTS Error:", error);
            }
        }
    </script>

</body>
</html>
